+++
title = "Mocking functions in Go"
date = 2014-04-10T11:35:00Z
updated = 2014-05-06T09:54:05Z
tags = ["Go", "testing", "programming", "golang"]
blogimport = true 
type = "post"
[author]
	name = "Nate Finch"
	uri = "https://plus.google.com/115818189328363361527"
+++

Functions in Go are first class citizens, that means you can have a variable that contains a function value, and call it like a regular function.<br /><blockquote class="tr_bq"><span style="font-family: Courier New, Courier, monospace; font-size: x-small;">printf := fmt.Printf<br />printf("This will output %d line.\n", 1)</span></blockquote>This ability can come in very handy for testing code that calls a function which is hard to properly test while testing the surrounding code. &nbsp;In <a href="http://juju.ubuntu.com/" target="_blank">Juju</a>, we occasionally use function variables to allow us to stub out a difficult function during tests, in order to more easily test the code that calls it. &nbsp;Here's a simplified example:<br /><blockquote class="tr_bq"><span style="font-family: Courier New, Courier, monospace;"><span style="font-size: x-small;">// in install/mongodb.go<br />package install<br /><br />func SetupMongodb(path string) error {<br />&nbsp; &nbsp; &nbsp;// suppose the code in this method modifies files in root<br />&nbsp; &nbsp; &nbsp;// directories, mucks with the environment, etc... <br />&nbsp; &nbsp; &nbsp;// Actions you actively don't want to do during most tests.<br />}</span></span></blockquote><blockquote class="tr_bq"><span style="font-family: Courier New, Courier, monospace;"><span style="font-size: x-small;"> <br />// in startup/bootstrap.go<br />package startup<br /><br />func Bootstrap() error {<br />&nbsp; &nbsp; ...<br />&nbsp; &nbsp; path := getPath()<br />&nbsp; &nbsp; if err := install.SetupMongodb(path); err != nil {<br />&nbsp; &nbsp; &nbsp; &nbsp;return err<br />&nbsp; &nbsp; }<br />&nbsp; &nbsp; ...<br />}</span></span></blockquote>So, suppose you want to write a test for Bootstrap, but you know SetupMongodb won't work, because the tests don't run with root privileges (and you don't want to setup mongodb on the dev's machine anyway). &nbsp;What can you do? &nbsp;This is where mocking comes in.<br /><br />We just make a little tweak to Bootstrap:<br /><blockquote class="tr_bq"><span style="font-family: Courier New, Courier, monospace;"><span style="font-size: x-small;">package startup<br /><br />var setupMongo = install.SetupMongodb<br /><br />func Bootstrap() error {<br />&nbsp; &nbsp; ...<br />&nbsp; &nbsp; path := getRootDirPath()<br />&nbsp; &nbsp; if err := setupMongo(path); err != nil {<br />&nbsp; &nbsp; &nbsp; &nbsp;return err<br />&nbsp; &nbsp; }<br />&nbsp; &nbsp; ...<br />}</span></span></blockquote>Now if we want to test Bootstrap, we can mock out the setupMongo function thusly:<br /><blockquote class="tr_bq"><span style="font-family: Courier New, Courier, monospace;"><span style="font-size: x-small;">// in startup/bootstrap_test.go<br />package startup<br /><br />type fakeSetup struct {<br />&nbsp; &nbsp; path string<br />&nbsp; &nbsp; err error<br />}<br /><br />func (f *fakeSetup) setup(path string) error {<br />&nbsp; &nbsp; f.path = path<br />&nbsp; &nbsp; return f.err<br />}<br /><br />TestBootstrap(t *testing.T) {<br />&nbsp; &nbsp; f := &amp;fakeSetup{ err: errors.New("Failed!") }<br />&nbsp; &nbsp; // this mocks out the function that Bootstrap() calls<br />&nbsp; &nbsp; setupMongo = f.setup<br />&nbsp; &nbsp; err := Bootstrap()<br />&nbsp; &nbsp; if err != f.err {<br />&nbsp; &nbsp; &nbsp; &nbsp; t.Fail("Error from setupMongo not returned.  Expected %v, got %v", f.err, err)<br />&nbsp; &nbsp; }<br />&nbsp; &nbsp; expPath := getPath()<br />&nbsp; &nbsp; if f.path != expPath {<br />&nbsp; &nbsp; &nbsp; &nbsp; t.Fail("Path not correctly passed into setupMongo. Expected %q, got %q", expPath, f.path)<br />&nbsp; &nbsp; }<br /><br />&nbsp; &nbsp; // and then try again with f.err == nil, you get the idea<br />}</span></span></blockquote>Now we have full control over what happens in the setupMongo function, we can record the parameters that are passed into it, what it returns, and test that Bootstrap is at least using the API of the function correctly.<br /><br />Obviously, we need tests elsewhere for install.SetupMongodb to make sure it does the right thing, but those can be tests internal to the install package, which can use non-exported fields and functions to effectively test the logic that would be impossible from an external package (like the setup package).  Using this mocking means that we don't have to worry about setting up an environment that allows us to test SetupMongodb when we really only want to test Bootstrap. &nbsp;We can just stub out the function and test that Bootstrap does everything correctly, and trust that SetupMongodb works because it's tested in its own package.
